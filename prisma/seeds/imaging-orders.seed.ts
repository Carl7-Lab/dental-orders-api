import {
  PrismaClient,
  OrderStatus,
  RadiographService,
  ComplementaryService,
  TomographyService,
  OrthodonticPackage,
  IndividualOrthodonticStudy,
} from '@prisma/client';

const prisma = new PrismaClient();

async function main(): Promise<void> {
  console.log('üìã Iniciando semilla de √≥rdenes de imagen...');

  const users = await prisma.user.findMany();
  const patients = await prisma.patient.findMany();
  const clinics = await prisma.clinic.findMany();

  if (users.length === 0) {
    console.error(
      '‚ùå No hay usuarios en la base de datos. Ejecuta primero: npm run seed:users',
    );
    process.exit(1);
  }

  if (patients.length === 0) {
    console.error(
      '‚ùå No hay pacientes en la base de datos. Ejecuta primero: npm run seed:patients',
    );
    process.exit(1);
  }

  if (clinics.length === 0) {
    console.error(
      '‚ùå No hay cl√≠nicas en la base de datos. Ejecuta primero: npm run seed:clinics',
    );
    process.exit(1);
  }

  console.log(`üë®‚Äç‚öïÔ∏è Usuarios disponibles: ${users.length}`);
  console.log(`üè• Pacientes disponibles: ${patients.length}`);
  console.log(`üè• Cl√≠nicas disponibles: ${clinics.length}`);

  const getRandomDate = (): Date => {
    const now = new Date();
    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const randomTime =
      thirtyDaysAgo.getTime() +
      Math.random() * (now.getTime() - thirtyDaysAgo.getTime());
    return new Date(randomTime);
  };

  const getRandomRadiographService = (): RadiographService => {
    const services = Object.values(RadiographService);
    return services[Math.floor(Math.random() * services.length)];
  };

  const getRandomComplementaryService = (): ComplementaryService => {
    const services = Object.values(ComplementaryService);
    return services[Math.floor(Math.random() * services.length)];
  };

  const getRandomTomographyService = (): TomographyService => {
    const services = Object.values(TomographyService);
    return services[Math.floor(Math.random() * services.length)];
  };

  const getRandomOrthodonticPackage = (): OrthodonticPackage => {
    const packages = Object.values(OrthodonticPackage);
    return packages[Math.floor(Math.random() * packages.length)];
  };

  const getRandomIndividualStudy = (): IndividualOrthodonticStudy => {
    const studies = Object.values(IndividualOrthodonticStudy);
    return studies[Math.floor(Math.random() * studies.length)];
  };

  const imagingOrders = [
    {
      status: OrderStatus.COMPLETED,
      orderDate: getRandomDate(),
      radiographService: getRandomRadiographService(),
      reportRequired: true,
      studyObjective: 'Evaluaci√≥n de caries interproximales',
      observations: 'Paciente con historia de caries recurrente',
      toothNumber: '16, 17, 26, 27',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.PENDING,
      orderDate: getRandomDate(),
      radiographService: getRandomRadiographService(),
      complementaryService: getRandomComplementaryService(),
      reportRequired: false,
      studyObjective: 'Control post-tratamiento',
      observations: 'Seguimiento de tratamiento endod√≥ntico',
      toothNumber: '14',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.IN_PROGRESS,
      orderDate: getRandomDate(),
      tomographyService: getRandomTomographyService(),
      reportRequired: true,
      studyObjective: 'Planificaci√≥n de implantes',
      observations: 'Evaluaci√≥n de densidad √≥sea',
      toothNumber: '11, 21',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.COMPLETED,
      orderDate: getRandomDate(),
      orthodonticPackage: getRandomOrthodonticPackage(),
      reportRequired: true,
      studyObjective: 'Estudio ortod√≥ntico completo',
      observations: 'Paciente adolescente, maloclusi√≥n clase II',
      toothNumber: 'Todas las piezas',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.CANCELLED,
      orderDate: getRandomDate(),
      individualOrthodonticStudy: getRandomIndividualStudy(),
      reportRequired: false,
      studyObjective: 'Cefalometr√≠a lateral',
      observations: 'Paciente no se present√≥ a la cita',
      toothNumber: null,
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.PENDING,
      orderDate: getRandomDate(),
      radiographService: getRandomRadiographService(),
      tomographyService: getRandomTomographyService(),
      reportRequired: true,
      studyObjective: 'Diagn√≥stico de patolog√≠a maxilofacial',
      observations: 'Sospecha de quiste en maxilar superior',
      toothNumber: '13, 14, 15',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.COMPLETED,
      orderDate: getRandomDate(),
      radiographService: getRandomRadiographService(),
      complementaryService: getRandomComplementaryService(),
      reportRequired: true,
      studyObjective: 'Control de periodontitis',
      observations: 'Paciente con enfermedad periodontal avanzada',
      toothNumber: 'Todas las piezas',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.IN_PROGRESS,
      orderDate: getRandomDate(),
      tomographyService: getRandomTomographyService(),
      reportRequired: true,
      studyObjective: 'Evaluaci√≥n de ATM',
      observations: 'Dolor articular y limitaci√≥n de apertura',
      toothNumber: null,
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.PENDING,
      orderDate: getRandomDate(),
      orthodonticPackage: getRandomOrthodonticPackage(),
      reportRequired: false,
      studyObjective: 'Seguimiento de tratamiento ortod√≥ntico',
      observations: 'Control mensual de brackets',
      toothNumber: 'Todas las piezas',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.COMPLETED,
      orderDate: getRandomDate(),
      radiographService: getRandomRadiographService(),
      reportRequired: true,
      studyObjective: 'Evaluaci√≥n pre-operatoria',
      observations: 'Cirug√≠a de terceros molares programada',
      toothNumber: '18, 28, 38, 48',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.IN_PROGRESS,
      orderDate: getRandomDate(),
      individualOrthodonticStudy: getRandomIndividualStudy(),
      reportRequired: true,
      studyObjective: 'An√°lisis cefalom√©trico',
      observations: 'Paciente con prognatismo mandibular',
      toothNumber: null,
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.PENDING,
      orderDate: getRandomDate(),
      radiographService: getRandomRadiographService(),
      complementaryService: getRandomComplementaryService(),
      reportRequired: false,
      studyObjective: 'Control rutinario',
      observations: 'Paciente con buena higiene oral',
      toothNumber: 'Todas las piezas',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.COMPLETED,
      orderDate: getRandomDate(),
      tomographyService: getRandomTomographyService(),
      reportRequired: true,
      studyObjective: 'Planificaci√≥n de cirug√≠a ortogn√°tica',
      observations: 'Maloclusi√≥n clase III severa',
      toothNumber: null,
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.CANCELLED,
      orderDate: getRandomDate(),
      radiographService: getRandomRadiographService(),
      reportRequired: false,
      studyObjective: 'Evaluaci√≥n de trauma dental',
      observations: 'Paciente cancel√≥ por motivos personales',
      toothNumber: '11, 12',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
    {
      status: OrderStatus.PENDING,
      orderDate: getRandomDate(),
      orthodonticPackage: getRandomOrthodonticPackage(),
      reportRequired: true,
      studyObjective: 'Inicio de tratamiento ortod√≥ntico',
      observations: 'Paciente adolescente, maloclusi√≥n clase I',
      toothNumber: 'Todas las piezas',
      userId: users[Math.floor(Math.random() * users.length)].id,
      patientId: patients[Math.floor(Math.random() * patients.length)].id,
      clinicId: clinics[Math.floor(Math.random() * clinics.length)].id,
    },
  ];

  let createdCount = 0;
  let errorCount = 0;

  for (const orderData of imagingOrders) {
    try {
      await prisma.imagingOrder.create({
        data: orderData,
      });
      createdCount++;
      console.log(
        `‚úÖ Orden de imagen creada: ${orderData.status} para paciente ${orderData.patientId}`,
      );
    } catch (error) {
      errorCount++;
      console.error(
        `‚ùå Error creando orden de imagen para paciente ${orderData.patientId}:`,
        error,
      );
    }
  }

  const totalOrders = await prisma.imagingOrder.count();
  const ordersByStatus = await prisma.imagingOrder.groupBy({
    by: ['status'],
    _count: { status: true },
  });

  console.log('');
  console.log('üéâ Semilla de √≥rdenes de imagen completada!');
  console.log(`üìä Estad√≠sticas:`);
  console.log(`   - √ìrdenes creadas: ${createdCount}`);
  console.log(`   - Errores: ${errorCount}`);
  console.log(`   - Total de √≥rdenes en BD: ${totalOrders}`);
  console.log('');
  console.log('üìà Distribuci√≥n por estado:');
  ordersByStatus.forEach((group) => {
    console.log(`   - ${group.status}: ${group._count.status} √≥rdenes`);
  });
  console.log('');
  console.log(
    'üìã Las 15 √≥rdenes de imagen est√°n listas para usar en el sistema.',
  );
}

main()
  .catch((e) => {
    console.error(
      '‚ùå Error durante la ejecuci√≥n de semillas de √≥rdenes de imagen:',
      e,
    );
    process.exit(1);
  })
  .finally(() => {
    void prisma.$disconnect();
  });
